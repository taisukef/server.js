<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width">
<title>Denoでログイン付きBBS</title>

<script type="module">
import { fetchJSON } from "https://js.sabae.cc/fetchJSON.js";
import { enc } from "https://js.sabae.cc/enc.js";
import { DateTime } from "https://code4fukui.github.io/day-es/DateTime.js";
import { hash } from "https://js.sabae.cc/hash.js";

window.onload = async () => {
    let session = null;

    const load = async () => {
        const data = await fetchJSON("api/list");
        console.log(data);
        container.innerHTML = "";
        for (const d of data) {
            const div = document.createElement("div");
            div.className = "bbsitem";
            div.innerHTML = `<span class=date>${enc(d.date)}</span> by <span class=name>${enc(d.name)}</span>
                <div class=body>${enc(d.body)}</div>`
            container.appendChild(div);
        }
    };
    load();

    btn_regist.onclick = async () => {
        const item = {
            name: inp_name.value.trim(),
            password: hash(inp_password.value),
            date: new DateTime(),
        };
        const res = await fetchJSON("api/regist", item);
        if (!res) {
            alert("ユーザー登録またはログインに失敗しました");
            return;
        }
        session = res;
        inp_password.value = "";
        regist.style.display = "none";
        logout.style.display = "block";
        write.style.display = "block";
    };

    btn_write.onclick = async () => {
        if (!session) {
            alert("ユーザー登録してください")
            return;
        }
        const item = {
            name: inp_name.value,
            body: inp_body.value,
            date: new DateTime(),
            session,
        };
        if (await fetchJSON("api/add", item) != "ok") {
            alert("書き込みに失敗しました");
            return;
        }
        inp_body.value = "";
        await load();
    };

    logout.onclick = () => {
        session = null;
        regist.style.display = "block";
        logout.style.display = "none";
        write.style.display = "none";
    };
};
</script>

<style>
.bbsitem {
    border-top: 1px solid gray;
    margin: 1em;
}
.writebox {
    border: 2px solid gray;
    padding: 1em;
    margin: 1em;
}
input, textarea {
    width: 80%;
}
</style>

<link rel="stylesheet" href="https://unpkg.com/sakura.css/css/sakura.css" type="text/css">
</head>

<body>
<h1>Denoでログイン付きBBS</h1>
<div id=container></div>

<div id=regist class=writebox>
    名前：<input type=text id=inp_name><br>
    パスワード：<input type=password id=inp_password><br>
    <button id=btn_regist>ユーザー登録 or ログイン</button>
</div>

<div id=write class=writebox style="display:none">
    <textarea id=inp_body></textarea><br>
    <button id=btn_write>書き込む</button>
</div>

<button id=logout style="display:none">ログアウト</button>

<footer>App: CC BY <a href=https://fukuno.jig.jp/3315>@taisukef</a></footer>
</body>

</html>
